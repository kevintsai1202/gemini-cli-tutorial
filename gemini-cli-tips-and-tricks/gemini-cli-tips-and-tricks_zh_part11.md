## 技巧 19：自訂 $PATH（和工具可用性）以實現穩定性

**快速用例：** 如果您發現 Gemini CLI 混淆或調用了錯誤的程式，請考慮使用量身定制的 `$PATH` 運行它。透過限制或排序可用的可執行檔，您可以防止 AI，例如，調用您不打算調用的名稱相似的腳本。本質上，您將其工具存取沙盒化為已知良好的工具。

對於大多數用戶來說，這不是問題，但對於擁有大量自訂腳本或多個工具版本的高級用戶來說，這可能會有所幫助。開發人員提到的一個原因是避免無限迴圈或奇怪的行為。例如，如果 `gemini` 本身在 `$PATH` 中，一個失控的 AI 可能會從 Gemini 內部遞歸調用 `gemini`（一個奇怪的場景，但理論上可能）。或者您可能有一個名為 `test` 的命令與某些東西衝突——AI 可能會調用錯誤的命令。

**如何為 Gemini 設定 PATH：** 最簡單的方法是在啟動時內聯：

```pwsh
$env:PATH="/usr/bin:/usr/local/bin"; gemini
```

這會以僅包含這些目錄的受限制 `$PATH` 運行 Gemini CLI。您可能會排除包含實驗性或危險腳本的目錄。或者，建立一個小型 shell 腳本包裝器，它清除或調整 `$PATH` 然後 `exec` `gemini`。

另一種方法是使用環境或配置來明確禁用某些工具。例如，如果您絕對不希望 AI 使用 `rm` 或某些破壞性工具，您可以在安全的 `$PATH` 中技術上建立一個別名或虛擬 `rm`，它什麼也不做（儘管這可能會干擾正常操作，所以可能不是那個）。更好的方法是設定中的排除列表。在擴展或 `settings.json` 中，您可以排除工具名稱。例如：

```json
“excludeTools”: [”run_shell_command”]
```

這個極端範例將阻止所有 shell 命令運行（使 Gemini 實際上是只讀的）。更細粒度地，有人提到跳過某些命令的確認；同樣，您可能會配置類似以下內容：

```json
“tools”: {
  “exclude”: [”apt-get”, “shutdown”]
}
```

（此語法僅供說明；請查閱文件以獲取確切用法。）

原則是，透過控制環境，您可以降低 AI 使用不應使用的工具做蠢事的風險。這類似於對房屋進行兒童防護。

**防止無限迴圈：** 一個用戶場景是一個迴圈，其中 Gemini 不斷讀取自己的輸出或重複讀取檔案。自訂 `$PATH` 無法直接修復邏輯迴圈，但一個原因可能是如果 AI 調用一個觸發自身的命令。確保它不會意外產生另一個 AI 實例（例如調用 `bard` 或 `gemini` 命令，如果它想到這樣做）是好的。從 `$PATH` 中移除這些（或為該會話重新命名它們）會有所幫助。

**透過沙盒隔離：** 另一種替代修改 `$PATH` 的方法是使用 `--sandbox` 模式（它使用 Docker 或 Podman 在隔離環境中運行工具）。在這種情況下，AI 的操作受到限制，並且只有沙盒映像提供的工具。您可以提供一個帶有精選工具集的 Docker 映像。這很笨重但非常安全。

**特定任務的自訂 PATH：** 您可能為不同的專案設定了不同的 `$PATH`。例如，在一個專案中，您希望它使用特定版本的 Node 或本機工具鏈。使用指向這些版本的 `$PATH` 啟動 `gemini` 將確保 AI 使用正確的版本。本質上，將 Gemini CLI 視為任何用戶——它使用您提供的任何環境。所以，如果您需要它選擇 `gcc-10` 而不是 `gcc-12`，請相應地調整 `$PATH` 或 `CC` 環境變數。

總結：防護措施。作為高級用戶，您有能力微調 AI 的操作條件。如果您發現與工具使用相關的不良行為模式，調整 `$PATH` 是一種快速補救措施。對於日常使用，您可能不需要這樣做，但如果您將 Gemini CLI 整合到自動化或 CI 中，這是一個值得記住的專業技巧：為它提供一個受控環境。這樣，您就可以確切地知道它能做什麼和不能做什麼，這會提高可靠性。

## 技巧 20：使用 Token 快取和統計資料追蹤和減少 Token 消耗

如果您運行長時間的聊天或重複附加相同的巨大檔案，您可以透過開啟 Token 快取和監控使用情況來降低成本和延遲。使用 API 金鑰或 Vertex AI 身份驗證，Gemini CLI 會自動重複使用先前傳送的系統指令和上下文，因此後續請求會更便宜。您可以在 CLI 中即時看到節省的費用。

**如何使用**

*   **使用啟用快取的身份驗證模式。** 當您使用 Gemini API 金鑰或 Vertex AI 進行身份驗證時，Token 快取可用。目前不支援 OAuth 登入。Google Gemini
*   **檢查您的使用情況和快取命中。** 在會話期間運行 `stats` 命令。它會顯示總 Token 數和快取啟用時的快取欄位。

    ```sh
    /stats
    ```

    該命令的描述和快取報告行為記錄在命令參考和常見問題中。Google Gemini+1
*   **在腳本中捕獲指標。** 在無頭模式下運行時，輸出 JSON 並解析統計區塊，其中包含每個模型的 `tokens.cached`：

    ```pwsh
    gemini -p “總結 README” --output-format json
    ```

    無頭指南記錄了帶有快取 Token 計數的 JSON 模式。Google Gemini
*   **將會話摘要儲存到檔案：** 對於 CI 或預算追蹤，將 JSON 會話摘要寫入磁碟。

    ```pwsh
    gemini -p “分析日誌” --session-summary usage.json
    ```

    此標誌列在變更日誌中。Google Gemini

使用 API 金鑰或 Vertex 身份驗證，CLI 會自動重複使用先前傳送的上下文，因此後續回合傳送的 Token 更少。保持 `GEMINI.md` 和大型檔案引用在回合之間穩定會增加快取命中；您會在統計資料中看到這反映為快取 Token。
